---
title: "Resistance data tables"
output:
  html_document:
    css: "css/main.css"
---

Report generated at: `r format(as.POSIXct(Sys.time(), format = "%y%m%d %H:%M"), "%m/%d/%Y %I:%M %p")` PDT

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(gridExtra)
knitr::opts_chunk$set(echo = FALSE)
source("./lib/readers.R", chdir = TRUE)
source("./lib/datatables.R", chdir = TRUE)


partialResistFold = 3
resistFold = 10
dfSuscResultsMAb = read.suscResultsMAb(withExcluded = TRUE)
dfSuscResultsCP = read.suscResultsCP(
  partialResistFold = partialResistFold,
  resistFold = resistFold,
  withExcluded = TRUE
)
dfSuscResultsIP = read.suscResultsIP(
  partialResistFold = partialResistFold,
  resistFold = resistFold,
  withExcluded = TRUE
)
dfSuscResultsCP$group = "CP"
dfSuscResultsIP$group = "IP"
dfSuscResultsPlasma = bind_rows(dfSuscResultsCP, dfSuscResultsIP)
dfVirusStrains = read.virusStrains() %>%
  select(strain_name, num_muts)
dfArticles = read.articles()
dfStrainMutations = read.strainMutations()

dfSuscResultsMAb = dfSuscResultsMAb %>%
  inner_join(
    dfVirusStrains,
    by = "strain_name",
    suffix = c(".susc", ".strain")
  ) %>%
  inner_join(
    dfArticles,
    by = "ref_name",
    suffix = c(".susc", ".ref")
  )

dfSuscResultsPlasma = dfSuscResultsPlasma %>%
  inner_join(
    dfVirusStrains,
    by = "strain_name",
    suffix = c(".susc", ".strain")
  ) %>%
  inner_join(
    dfArticles,
    by = "ref_name",
    suffix = c(".susc", ".ref")
  )
```

## Individual spike mutations / mAb neutralization

Columns explained:

- __Author__: first author name + publish date, a unique reference to each paper.
- __DOI__: DOI of the paper.
- __Source__: where to find the data in corresponding paper.
- __Date__: when was the data added into database.
- __mAb__: monoclonal antibodies, including names and categories, multiple mAbs are combined by plus sign, you can find abbreviations [here](https://covdb.stanford.edu/page/susceptibility-data/).
- __Position__: SARS-CoV-2 Spike protein position according to reference sequence(Genbank: [NC_045512.2](https://www.ncbi.nlm.nih.gov/nuccore/1798174254)).
- __AA__: amino acid mutation.
- __FoldCmp__: for data from charts we provide estimate fold value(<: less than, >: great than, ~:approximately).
- __Fold__: drug susceptibility fold change compare to wild type(<3: susceptible, 3~10: partial resistance, >10: resistance).
- __Assay__: pseudo virus or live virus, default is pseudo virus.
- __Include__: if the data have some issues we would exclude them from analysis.

You can copy, download, or print the table using buttons below:

```{r phenotypes-mut-mab}

dfSuscResultsMAb %>%
  filter(num_muts == 1) %>%
  inner_join(
    dfStrainMutations,
    by = "strain_name",
    suffix = c(".susc", ".strainMut")
  ) %>%
  mutate(
    DOI = ifelse(is.na(doi), url, doi),
    mAb = Vectorize(function(x) paste0(x, collapse = "+"))(short_ab_name_with_author_target),
    FoldCmp = ifelse(fold_cmp == "=", "", fold_cmp),
    Fold = ifelse(is.na(fold), "", fold),
    Assay = ifelse(is.na(assay), "", assay),
    Include = ifelse(include, "Yes", "No")
  ) %>%
  select(
    Author = ref_name,
    DOI,
    Source = section,
    Date = date_added.susc,
    mAb,
    Position = position,
    AA = amino_acid,
    FoldCmp,
    Fold,
    Assay,
    Include
  ) %>%
  arrange(
    Author,
    Position,
    AA,
    mAb
  ) %>%
  styledDT
```

## Individual spike mutations / plasma neutralization

Columns explained:

- __Author__: first author name + publish date, a unique reference to each paper.
- __DOI__: DOI of the paper.
- __Source__: where to find the data in corresponding paper.
- __Date__: when was the data added into database.
- __Plasma__: which kinds of plasma was used(CP: convalescent plasma, BNT162b2: plasma from BNT162b2 vaccinated persons, mRNA-1273: plasma from mRNA-1273 vaccinated persons).
- __Vaccine__: vaccine name.
- __Position__: SARS-CoV-2 Spike protein position according to reference sequence(Genbank: [NC_045512.2](https://www.ncbi.nlm.nih.gov/nuccore/1798174254)).
- __AA__: amino acid mutation.
- __FoldCmp__: for data from charts we provide estimate fold value(<: less than, >: great than, ~:approximately).
- __Fold__: drug susceptibility fold change compare to wild type(<3: susceptible, 3~10: partial resistance, >10: resistance).
- __Level__: for some papers only provide susceptibility level not fold change data, so we keep the susceptibility level data.
- __Assay__: pseudo virus or live virus, default is pseudo virus.
- __Count__: for some papers the fold change or susceptibility level apply to multiple experiments, default is 1.
- __Include__: if the data have some issues we would exclude them from analysis.

You can copy, download, or print the table using buttons below:

```{r phenotypes-mut-plasma}

dfMutPlasma = dfSuscResultsPlasma %>%
  filter(num_muts == 1) %>%
  inner_join(
    dfStrainMutations,
    by = "strain_name",
    suffix = c(".susc", ".strainMut")
  )
dfMutPlasma %>%
  mutate(
    DOI = ifelse(is.na(doi), url, doi),
    Plasma = Vectorize(function(refName, rxName, strainName, ordNum) {
      total = nrow(filter(dfMutPlasma, rx_name == rxName & ref_name == refName & strain_name == strainName))
      ifelse(
        total == 1,
        yes = rxName,
        no = sprintf(sprintf("%%s:%%0%dd", 1 + floor(log(total, 10))), rxName, ordNum)
      )
    })(ref_name, rx_name, strain_name, ordinal_number),
    Vaccine = ifelse(is.na(vaccine_name), "", vaccine_name),
    FoldCmp = ifelse(fold_cmp == "=", "", fold_cmp),
    Fold = ifelse(is.na(fold), "", fold),
    Assay = ifelse(is.na(assay), "", assay),
    Count = ifelse(cumulative_count == 1, "", cumulative_count),
    Include = ifelse(include, "Yes", "No")
  ) %>%
  select(
    Author = ref_name,
    DOI,
    Source = section,
    Date = date_added.susc,
    Plasma,
    Vaccine,
    Position = position,
    AA = amino_acid,
    FoldCmp,
    Fold,
    Level = resistance_level,
    Assay,
    Count,
    Include
  ) %>%
  arrange(
    Author,
    Position,
    AA,
    Plasma,
    Vaccine
  ) %>%
  styledDT
```

## Spike variants and mutation combinations / mAb neutralization

Columns explained:

- __Author__: first author name + publish date, a unique reference to each paper.
- __DOI__: DOI of the paper.
- __Source__: where to find the data in corresponding paper.
- __Date__: when was the data added into database.
- __mAb__: monoclonal antibodies, including names and categories, multiple mAbs are combined by plus sign, you can find abbreviations [here](https://covdb.stanford.edu/page/susceptibility-data/).
- __Strain__: variants of concern(B.1.1.7, B.1.351, P.1, etc), you can find all mutations [here](https://covdb.stanford.edu/page/mutation-viewer/), or combination of spike mutations(like S:69del+70del+453F).
- __FoldCmp__: for data from charts we provide estimate fold value(<: less than, >: great than, ~:approximately).
- __Fold__: drug susceptibility fold change compare to wild type(<3: susceptible, 3~10: partial resistance, >10: resistance).
- __Assay__: pseudo virus or live virus, default is pseudo virus.
- __Include__: if the data have some issues we would exclude them from analysis.

You can copy, download, or print the table using buttons below:


```{r phenotypes-strain-mab}

dfSuscResultsMAb %>%
  filter(num_muts > 1) %>%
  mutate(
    DOI = ifelse(is.na(doi), url, doi),
    mAb = Vectorize(function(x) paste0(x, collapse = "+"))(short_ab_name_with_author_target),
    FoldCmp = ifelse(fold_cmp == "=", "", fold_cmp),
    Fold = ifelse(is.na(fold), "", fold),
    Assay = ifelse(is.na(assay), "", assay),
    Include = ifelse(include, "Yes", "No")
  ) %>%
  select(
    Author = ref_name,
    DOI,
    Source = section,
    Date = date_added.susc,
    mAb,
    Strain = strain_name,
    FoldCmp,
    Fold,
    Assay,
    Include
  ) %>%
  arrange(
    Author,
    Strain,
    mAb
  ) %>%
  styledDT
```

## Spike variants and mutation combinations / plasma neutralization

Columns explained:

- __Author__: first author name + publish date, a unique reference to each paper.
- __DOI__: DOI of the paper.
- __Source__: where to find the data in corresponding paper.
- __Date__: when was the data added into database.
- __Plasma__: which kinds of plasma was used(CP: convalescent plasma, BNT162b2: plasma from BNT162b2 vaccinated persons, mRNA-1273: plasma from mRNA-1273 vaccinated persons).
- __Vaccine__: vaccine name.
- __Strain__: variants of concern(B.1.1.7, B.1.351, P.1, etc), you can find all mutations [here](https://covdb.stanford.edu/page/mutation-viewer/), or combination of spike mutations(like S:69del+70del+453F).
- __FoldCmp__: for data from charts we provide estimate fold value(<: less than, >: great than, ~:approximately).
- __Fold__: drug susceptibility fold change compare to wild type(<3: susceptible, 3~10: partial resistance, >10: resistance).
- __Level__: for some papers only provide susceptibility level not fold change data, so we keep the susceptibility level data.
- __Assay__: pseudo virus or live virus, default is pseudo virus.
- __Count__: for some papers the fold change or susceptibility level apply to multiple experiments, default is 1.
- __Include__: if the data have some issues we would exclude them from analysis.

You can copy, download, or print the table using buttons below:


```{r phenotypes-strain-plasma}

dfStrainPlasma = dfSuscResultsPlasma %>%
  filter(num_muts > 1)
dfStrainPlasma %>%
  mutate(
    DOI = ifelse(is.na(doi), url, doi),
    Plasma = Vectorize(function(refName, rxName, strainName, ordNum) {
      total = nrow(filter(dfStrainPlasma, rx_name == rxName & ref_name == refName & strain_name == strainName))
      ifelse(
        total == 1,
        yes = rxName,
        no = sprintf(sprintf("%%s:%%0%dd", 1 + floor(log(total, 10))), rxName, ordNum)
      )
    })(ref_name, rx_name, strain_name, ordinal_number),
    Vaccine = ifelse(is.na(vaccine_name), "", vaccine_name),
    FoldCmp = ifelse(fold_cmp == "=", "", fold_cmp),
    Fold = ifelse(is.na(fold), "", fold),
    Assay = ifelse(is.na(assay), "", assay),
    Count = ifelse(cumulative_count == 1, "", cumulative_count),
    Include = ifelse(include, "Yes", "No")
  ) %>%
  select(
    Author = ref_name,
    DOI,
    Source = section,
    Date = date_added.susc,
    Plasma,
    Vaccine,
    Strain = strain_name,
    FoldCmp,
    Fold,
    Level = resistance_level,
    Assay,
    Count,
    Include
  ) %>%
  arrange(
    Author,
    Strain,
    Plasma,
    Vaccine
  ) %>%
  styledDT
```

## Spike mutation Invitro selection

Columns explained:

- __Author__: first author name + publish date, a unique reference to each paper.
- __DOI__: DOI of the paper.
- __Source__: where to find the data in corresponding paper.
- __Date__: when was the data added into database.
- __mAb__: monoclonal antibodies, including names and categories, multiple mAbs are combined by plus sign, you can find abbreviations [here](https://covdb.stanford.edu/page/susceptibility-data/).
- __Position__: SARS-CoV-2 Spike protein position according to reference sequence(Genbank: [NC_045512.2](https://www.ncbi.nlm.nih.gov/nuccore/1798174254)).
- __AAMutation__: amino acid mutation.

You can copy, download, or print the table using buttons below:

```{r invitro-selection}
invitroResults = read.invitroResults()
invitroResults = invitroResults %>%
  inner_join(
    dfArticles,
    by = "ref_name",
    suffix = c(".invitro", ".ref")
  )
invitroResults %>%
  mutate(
    DOI = ifelse(is.na(doi), url, doi),
    # mAb = Vectorize(function(x) paste0(x, collapse = "+"))(short_ab_name_with_author_target),
    mAb = rx_name,
    Position=position,
    AAMutation=amino_acid
  ) %>%
  select(
    Author = ref_name,
    DOI,
    Source = section,
    Date = date_added.invitro,
    mAb,
    Position,
    AAMutation
  ) %>%
  arrange(
    Author,
    mAb,
    Position,
    AAMutation
  ) %>%
  styledDT
```
