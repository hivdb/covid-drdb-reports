---
title: "Susceptibility data"
output:
  html_document:
    keep_md: yes
    css: "css/main.css"
---

Report generated at: `r format(as.POSIXct(Sys.time(), format = "%y%m%d %H:%M"), "%m/%d/%Y %I:%M %p")` PDT

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(gridExtra)
knitr::opts_chunk$set(echo = FALSE)
source("./lib/readers.R", chdir = TRUE)
source("./lib/datatables.R", chdir = TRUE)

partialResistFold = 3
resistFold = 10
dfSuscResultsMAb = read.suscResultsMAb()
dfSuscResultsCP = read.suscResultsCP(
  partialResistFold = partialResistFold,
  resistFold = resistFold
)
dfSuscResultsIP = read.suscResultsIP(
  partialResistFold = partialResistFold,
  resistFold = resistFold
)
dfSuscResultsCP$group = "CP"
dfSuscResultsIP$group = "IP"
dfSuscResultsPlasma = bind_rows(dfSuscResultsCP, dfSuscResultsIP)
dfVirusStrains = read.virusStrains() %>%
  select(strain_name, num_muts)
dfAntibodies = read.antibodies()

groupTitle = c(
  "CP" = "Convalescent plasma",
  "IP" = "Vaccinated plasma"
)
```


## Statistic Numbers

```{r numbers}
phase3MAbs = dfAntibodies %>%
  filter(!is.na(availability))

structuredMAbs = dfAntibodies %>%
  filter(!is.na(pdb_id))

dfSuscResults = dfSuscResultsMAb %>%
  mutate(
    group = "MAb",
    rx_group = ifelse(
      Vectorize(function(x) length(setdiff(x, phase3MAbs$ab_name)) == 0)(ab_name),
      yes = "phase3MAb",
      no = ifelse(
        Vectorize(function(x) length(setdiff(x, structuredMAbs$ab_name)) == 0)(ab_name),
        yes = "structuredMAb",
        no = "otherMAb"
      )
    )
  ) %>%
  bind_rows(dfSuscResultsPlasma) %>%
  merge(dfVirusStrains, by = "strain_name") %>%
  mutate(
    rx_group = factor(
      ifelse(
        group %in% c("CP", "IP"),
        yes = group,
        no = rx_group
      ),
      levels = c("CP", "IP", "phase3MAb", "structuredMAb", "otherMAb")
    ),
    strain_group = factor(
      ifelse(
        strain_name %in% c("S:501Y", "S:484K", "B.1.1.7 Spike", "B.1.351 Spike", "P.1 Spike"),
        yes = strain_name,
        no = ifelse(
          num_muts > 1,
          yes = "Other mutation combinations",
          no = "Other mutations"
        )
      ),
      levels = c("S:501Y", "S:484K", "Other mutations", "B.1.1.7 Spike",
                 "B.1.351 Spike", "P.1 Spike", "Other mutation combinations")
    )
  )

aggregate(cbind(num = ref_name) ~ rx_group + strain_group,
          dfSuscResults,
          FUN = length) %>%
  reshape(idvar = "strain_group", timevar = "rx_group", direction = "wide") %>%
  styledKBL

```

### Unique MAbs

```{r unique-mabs}
dfUsedMAbs = dfAntibodies %>%
  filter(ab_name %in% unique(unlist(dfSuscResultsMAb$ab_name))) %>%
  mutate(has_structure = factor(ifelse(is.na(pdb_id), "No", "Yes"), levels = c("Yes", "No")))

aggregate(cbind(count = ab_name) ~ has_structure, dfUsedMAbs, FUN = length) %>%
  styledKBL
```

## Convalescent and immune plasma

<span style="padding: .1rem .2rem; margin: 0 .2rem; border: 1px solid black; background-color: #146aa8; color: white;">fold ↓ susceptibility > `r resistFold`</span>&nbsp;
<span style="padding: .1rem .2rem; margin: 0 .2rem; border: 1px solid black; background-color: #7fcbee; color: black;">fold ↓ susceptibility `r partialResistFold` to `r resistFold`</span>&nbsp;
<span style="padding: .1rem .2rem; margin: 0 .2rem; border: 1px solid black; background-color: #ffffff; color: black;">fold ↓ susceptibility < `r partialResistFold`</span>

```{r plasma-fold-fig, fig.height = 10, fig.width = 12, fig.retina = 4}

strainTitle = c(
  "S:501Y" = "N501Y",
  "B.1.1.7 Spike" = "B.1.1.7",
  "S:484K" = "E484K",
  "B.1.351 Spike" = "B.1.351",
  "P.1 Spike" = "P.1"
  #"S:417N" = "417N",
  #"S:439K" = "439K",
  #"S:452R" = "452R",
  #"S:453F" = "453F"
)
filterStrains = names(strainTitle)
shortRefRxNames = c(
  "Cele21 CP_WT" = "CP_WT\nCele21",
  "Collier21 BNT" = "BNT\nCollier21",
  "Edara21 CP" = "Edara21\n",
  "Edara21 Mod" = "Mod\nEdara21",
  "Greaney21 CP" = "Greaney21\n",
  "Hoffmann21 BNT" = "BNT\nHoffmann21",
  "Hoffmann21 CP" = "CP\nHoffmann21",
  "Hu21 1mon" = "1M\nHu21",
  "Hu21 8mon" = "8M\nHu21",
  "Jangra21 CP" = "Jangra21\n",
  "Jangra21 BNT" = "BNT\nJangra21",
  "Liu21 CP" = "Liu21\n",
  "Muik21 BNT" = "BNT\nMuik21",
  "Rees-Spear21 mild" = "Mild\nRSC21",
  "Rees-Spear21 severe" = "Severe\nRSC21",
  "Shen21 CP_1M" = "Shen21\n",
  "Shen21 Mod" = "Mod\nShen21",
  "Shen21 NVV" = "NVX\nShen21",
  "Stamatatos21 CP" = "Statmatatos21\n",
  "Stamatatos21 BNT" = "BNT\nStatmatatos21",
  "Stamatatos21 Mod" = "Mod\nStatmatatos21",
  "Tada21 CP" = "Tada21\n",
  "Tada21 BNT" = "BNT\nTada21",
  "Wang21 BNT" = "BNT\nWang21",
  "Wang21 Mod" = "Mod\nWang21",
  "Wang21b CP" = "Wang21b\n",
  "Wang21b BNT" = "BNT\nWang21b",
  "Wang21b Mod" = "Mod\nWang21b",
  "Wibmer21 low titer" = "Titer < 400\nWibmer21",
  "Wibmer21 high titer" = "Titer > 400\nWibmer21",
  "Wu21 Mod" = "Mod\nWu21",
  "Xie21 BNT" = "BNT\nXie21",
  "Xie21b BNT" = "BNT\nXie21b"
)
yAxisStep = 5
longRefRxNames = names(shortRefRxNames)

dfForPlot = dfSuscResultsPlasma %>%
  filter(strain_name %in% filterStrains) %>%
  mutate(
    rx_name = ifelse(is.na(cumulative_group), rx_name, cumulative_group),
    vaccine_name = ifelse(is.na(vaccine_name), "NA", vaccine_name)
  )
dfForPlot = aggregate(
  cumulative_count ~ ref_name + rx_name + vaccine_name + strain_name + resistance_level + group,
  dfForPlot,
  FUN=sum,
  na.action = na.pass
)

resistance_levels = c(
  'resistance',
  'partial-resistance',
  'susceptible'
)

dfForPlot = dfForPlot %>%
  select(ref_name, rx_name, vaccine_name, strain_name, group) %>%
  unique %>%
  merge(
    data.frame(resistance_level = resistance_levels)
  ) %>%
  merge(
    dfForPlot,
    by = c('ref_name', 'rx_name', 'vaccine_name', 'strain_name', 'group', 'resistance_level'),
    all.x = TRUE
  ) %>%
  mutate(
    cumulative_count = ifelse(is.na(cumulative_count), 0, cumulative_count),
    resistance_level = factor(resistance_level, levels = resistance_levels),
    group = factor(
      group,
      levels = c("CP", "IP")
    ),
    ref_rx = paste(ref_name, rx_name, sep=" ")
  ) %>%
  mutate(
    ref_rx = factor(ref_rx, levels = unique(c(longRefRxNames, ref_rx)))
  )

plots = list()
i = 1

for (strain in filterStrains) {
  df = dfForPlot %>%
    filter(strain_name == strain)
  totalCount = aggregate(cbind(total_count = cumulative_count) ~ ref_rx + group, df, FUN = sum)
  maxCount = ceiling((max(totalCount$total_count)) / yAxisStep) * yAxisStep

  for (groupName in c("CP", "IP")) {
    dfGroup = df %>%
      filter(group == groupName)
    dfStrainLabel = data.frame(
      x = 0,
      y = maxCount,
      text = strainTitle[[strain]]
    )
    numItems = length(unique(dfGroup$ref_rx))
    plot = dfGroup %>%
      ggplot(aes(x = ref_rx, y = cumulative_count)) +
      geom_bar(
        aes(fill = resistance_level),
        size = 0.2,
        color = "#000000",
        stat = 'identity', position = 'stack', width = 0.07 * numItems) +
      scale_x_discrete(
        labels = Vectorize(function(x) ifelse(
          x %in% longRefRxNames,
          yes = shortRefRxNames[[x]],
          no = x
        ))
      ) +
      geom_text(
        aes(x = ref_rx, y = total_count, label = total_count),
        data = totalCount %>% filter(group == groupName),
        size = 3,
        vjust = -0.5
      ) +
      scale_y_continuous(
        expand = c(0, 0, 0.3, 0),
        limits = c(0, maxCount),
        breaks = seq(0, maxCount, yAxisStep)
      ) +
      # labs(title = strain) +
      scale_fill_manual(values = c("#146aa8", "#7fcbee", "#ffffff")) +
      theme(
        plot.title = element_text(hjust = 0.5),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        strip.background = element_blank(),
        strip.placement = "outside",
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "none",
        panel.border = element_rect(fill = NA, color = 'black')
      )
    if (i < 3) {
      plot = plot + ggtitle(groupTitle[[groupName]])
    }
    if (i %% 2 == 1) {
      plot = plot + geom_text(
        aes(x, y, label = text), data = dfStrainLabel,
        hjust = -0.15,
        vjust = -1
      )
    }
    else {
      plot = plot + theme(
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank()
      )
    }
    plots[[i]] = plot
    i = i + 1
  }
}
grid.arrange(grobs = plots, nrow = length(strainTitle))
```

## Monoclonal antibodies

```{r mab-fold-fig, fig.height = 20, fig.width = 24, fig.retina = 4, message = FALSE, warning = FALSE}
strainTitle = c(
  "S:501Y" = "N501Y",
  "B.1.1.7 Spike" = "B.1.1.7",
  "S:484K" = "E484K",
  "B.1.351 Spike" = "B.1.351",
  "P.1 Spike" = "P.1",
  "S:452R" = "L452R",
  "S:417N" = "K417N",
  "S:439K" = "N439K",
  "S:453F" = "Y453F"
)
filterStrains = names(strainTitle)
filterMAbs = structuredMAbs$ab_name %>%
  setdiff(
    c(
      "DH1041",  # PDB:7LAA, pending
      "5-24",  # PDB:7L2F, pending
      "910-30" # PDB:7KS9, pending
    )
  ) %>%
  union(phase3MAbs$ab_name)

# order of mAbs:
# - MAbs in clinical trial first; add the new trial MAb at the end of this group; well-known ones don't need class/target
# - MAbs with structure data should be ordered by their class: RBM 1, 2, 3, RBD-core 1, 2
# - Within a mAb class, order mAbs in alphabetical order
mAbLabels = c(
  "Bamlanivimab" = "BAM",
  "Casirivimab" = "CAS",
  "Imdevimab" = "IMD",
  "Casirivimab+\nImdevimab" = "CAS-IMD",
  "Etesevimab" = "ETE",
  "Cilgavimab" = "CIL",
  "Tixagevimab" = "TIX",
  "Tixagevimab+\nCilgavimab" = "TIX-CIL",
  "Bamlanivimab+\nEtesevimab" = "BAM-ETE",
  "Vir-7831" = "Vir-7831\n(S309)",
  "BRII-196" = "BRII-196",
  "BRII-198" = "BRII-198",
  "BRII-196+\nBRII-198" = "BRII-196+\nBRII-198",
  "JMB2002" = "JMB2002\n(RBD)",
  "B38" = "B38\n(RBM 1)",
  "BD-629" = "BD-629\n(RBM 1)",
  "CC12.1" = "CC12.1\n(RBM 1)",
  "COVA2-04" = "COVA2-04\n(RBM 1)",
  "CV30" = "CV30\n(RBM 1)",
  "DH1047" = "DH1047\n(RBM 1)",
  "P2C-1F11" = "P2C-1F11\n(RBM 1)",
  "S2E12" = "S2E12\n(RBM 1)",
  "S2H14" = "S2H14\n(RBM 1)",
  "BD-368-2" = "BD-368-2\n(RBM 2)",
  "C119" = "C119\n(RBM 2)",
  "C121" = "C121\n(RBM 2)",
  "P2B-2F6" = "P2B-2F6\n(RBM 2)",
  "2-4" = "2-4\n(RBM 3)",
  "BD23" = "BD23\n(RBM 3)",
  "C144" = "C144\n(RBM 3)",
  "S2M11" = "S2M11\n(RBM 3)",
  "C135" = "C135\n(RBD-core 1)",
  "COVA1-16" = "COVA1-16\n(RBD-core 2)",
  "H014" = "H014\n(RBD-core 2)",
  "S2X35" = "S2X35\n(RBD-core 2)",
  "4A8" = "4A8\n(NTD)"
)
mAbHasLabels = names(mAbLabels)

dfForPlot = dfSuscResultsMAb %>%
  filter(
    Vectorize(function(x) length(setdiff(x, filterMAbs)) == 0)(ab_name) &
    strain_name %in% filterStrains
  )  %>%
  mutate(
    ref_name = ifelse(
      ref_name == "Rees-Spear21",
      "RSC21",
      ref_name
    ),
    strain_name = factor(strain_name, levels = filterStrains),
    fold_cmp = ifelse(fold > 100, ">", fold_cmp),
    fold = ifelse(fold > 100, 100, fold),
    ab_name = Vectorize(function(x) paste(x, collapse = "+\n"))(ab_name)
  ) %>%
  mutate(
    ab_name = factor(
      ab_name,
      levels = unique(c(mAbHasLabels, ab_name))
    ),
    ref_name = factor(
      ref_name,
      levels = sort(unique(ref_name))
    )
  ) %>%
  select(ref_name, ab_name, strain_name, fold_cmp, fold) %>%
  group_by(ref_name, ab_name, strain_name, fold_cmp) %>%
  summarise(fold = max(fold))

dfNumAbs = dfForPlot %>%
  group_by(strain_name) %>%
  summarize(num_abs = length(unique(ab_name)))
dfForPlot = merge(dfForPlot, dfNumAbs, by = "strain_name")

maxNumAbs = max(dfForPlot$num_abs)
widthTimer = 0.95 / maxNumAbs

plots = list()
i = 1

dfStrainLabel = data.frame(
  x = 0,
  y = 190,
  strain_name = factor(filterStrains, levels = filterStrains),
  text = strainTitle
)

dfHLines = data.frame(
  y = c(1, 3, 10, 30, 100)
)

plot = dfForPlot %>%
  ggplot(aes(x = ab_name, y = fold)) +
  geom_hline(aes(yintercept = y), data = dfHLines, linetype = "dashed", color = "#e0e0e0") +
  geom_bar(
    aes(fill = ref_name, width = widthTimer * num_abs),
    size = 0.2,
    color = "#000000",
    stat = 'identity',
    position = position_dodge2(preserve = 'single')
  ) +
  labs(fill = "References")

for (strain in filterStrains) {
  dfPartial = dfForPlot %>% filter(strain_name == strain) %>% arrange(ref_name)
  numAbs = dfPartial$num_abs[[1]]
  plot = plot + geom_text(
    aes(
      y = Vectorize(function(x) min(x, 190))(fold),
      label = ifelse(
        fold_cmp == ">",
        sprintf(">%s", formatC(fold, digits = 1, format = 'fg')),
        ""
      )
    ),
    data = dfPartial,
    position = position_dodge2(preserve = 'single', width = (widthTimer - 0.014) * numAbs),
    size = 1.5,
    vjust = -0.5
  )
}
plot +
  geom_text(
    aes(x, y, label = text),
    #nudge_x = 0.5,
    data = dfStrainLabel,
    hjust = - 0.2,
    vjust = 0
  ) +
  scale_x_discrete(labels = Vectorize(function(x) ifelse(
    x %in% mAbHasLabels,
    yes = mAbLabels[[x]],
    no = x
  ))) +
  scale_y_continuous(
    trans=scales::pseudo_log_trans(base = 10),
    expand = c(0, 0, 0.1, 0),
    breaks = c(0, 1, 3, 10, 30, 100)
  ) +
  coord_cartesian(ylim = c(0, 200)) +
  facet_wrap(~ strain_name, scales = "free_x", nrow = length(filterStrains)) +
  theme(
    plot.title = element_text(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    strip.background = element_blank(),
    strip.text = element_blank(),
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(fill = NA, color = 'black')
  )
```
