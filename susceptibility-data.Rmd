---
title: "Susceptibility data"
output:
  html_document:
    keep_md: yes
    css: "css/main.css"
---

Report generated at: `r format(as.POSIXct(Sys.time(), format = "%y%m%d %H:%M"), "%m/%d/%Y %I:%M %p")` PDT

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(gridExtra)
knitr::opts_chunk$set(echo = FALSE)
source("./lib/readers.R", chdir = TRUE)
source("./lib/datatables.R", chdir = TRUE)

partialResistFold = 3
resistFold = 10
dfSuscResultsMAb = read.suscResultsMAb()
dfSuscResultsCP = read.suscResultsCP(
  partialResistFold = partialResistFold,
  resistFold = resistFold
)
dfSuscResultsIP = read.suscResultsIP(
  partialResistFold = partialResistFold,
  resistFold = resistFold
)
dfSuscResultsCP$group = "CP"
dfSuscResultsIP$group = "IP"
dfSuscResultsPlasma = bind_rows(dfSuscResultsCP, dfSuscResultsIP)
dfVirusStrains = read.virusStrains() %>%
  select(strain_name, num_muts)
dfAntibodies = read.antibodies()

filterStrains = c("S:501Y", "B.1.1.7 Spike", "S:484K", "B.1.351 Spike")

groupTitle = c(
  "CP" = "Convalescent plasma",
  "IP" = "Vaccinated plasma"
)

strainTitle = c(
  "S:501Y" = "N501Y",
  "B.1.1.7 Spike" = "B.1.1.7",
  "S:484K" = "E484K",
  "B.1.351 Spike" = "B.1.351"
)
```


## Statistic Numbers

```{r numbers}
phase3MAbs = dfAntibodies %>%
  filter(availability == "Investigational (human trials)")

structuredMAbs = dfAntibodies %>%
  filter(!is.na(pdb_id))

dfSuscResults = dfSuscResultsMAb %>%
  mutate(
    group = "MAb",
    rx_group = ifelse(
      Vectorize(function(x) length(setdiff(x, phase3MAbs$ab_name)) == 0)(ab_name),
      yes = "phase3MAb",
      no = ifelse(
        Vectorize(function(x) length(setdiff(x, structuredMAbs$ab_name)) == 0)(ab_name),
        yes = "structuredMAb",
        no = "otherMAb"
      )
    )
  ) %>%
  bind_rows(dfSuscResultsPlasma) %>%
  merge(dfVirusStrains, by = "strain_name") %>%
  mutate(
    rx_group = factor(
      ifelse(
        group %in% c("CP", "IP"),
        yes = group,
        no = rx_group
      ),
      levels = c("CP", "IP", "phase3MAb", "structuredMAb", "otherMAb")
    ),
    strain_group = factor(
      ifelse(
        strain_name %in% c("S:501Y", "S:484K", "B.1.1.7 Spike", "B.1.351 Spike"),
        yes = strain_name,
        no = ifelse(
          num_muts > 1,
          yes = "Other mutation combinations",
          no = "Other mutations"
        )
      ),
      levels = c("S:501Y", "S:484K", "Other mutations", "B.1.1.7 Spike",
                 "B.1.351 Spike", "Other mutation combinations")
    )
  )

aggregate(cbind(num = ref_name) ~ rx_group + strain_group,
          dfSuscResults,
          FUN = length) %>%
  reshape(idvar = "strain_group", timevar = "rx_group", direction = "wide") %>%
  styledKBL

```

### Unique MAbs

```{r unique-mabs}
dfUsedMAbs = dfAntibodies %>%
  filter(ab_name %in% unique(unlist(dfSuscResultsMAb$ab_name))) %>%
  mutate(has_structure = factor(ifelse(is.na(pdb_id), "No", "Yes"), levels = c("Yes", "No")))

aggregate(cbind(count = ab_name) ~ has_structure, dfUsedMAbs, FUN = length) %>%
  styledKBL
```

## Convalescent and immune plasma

<span style="padding: .1rem .2rem; margin: 0 .2rem; border: 1px solid black; background-color: #146aa8; color: white;">fold ↓ susceptibility > `r resistFold`</span>&nbsp;
<span style="padding: .1rem .2rem; margin: 0 .2rem; border: 1px solid black; background-color: #7fcbee; color: black;">fold ↓ susceptibility `r partialResistFold` to `r resistFold`</span>&nbsp;
<span style="padding: .1rem .2rem; margin: 0 .2rem; border: 1px solid black; background-color: #ffffff; color: black;">fold ↓ susceptibility < `r partialResistFold`</span>

```{r plasma-fold-fig, fig.height = 10, fig.width = 12, fig.retina = 4}
shortRefRxNames = c(
  "Collier21 BNT" = "BNT\nCollier21",
  "Greaney21 CP" = "Greaney21\n",
  "Hu21 1mon" = "1M\nHu21",
  "Hu21 8mon" = "8M\nHu21",
  "Jangra21 CP" = "Jangra21\n",
  "Jangra21 BNT" = "BNT\nJangra21",
  "Liu21 CP" = "Liu21\n",
  "Muik21 BNT" = "BNT\nMuik21",
  "Rees-Spear21 mild" = "Mild\nRSC21",
  "Rees-Spear21 severe" = "Severe\nRSC21",
  "Shen21 CP_1M" = "Shen21\n",
  "Shen21 Mod" = "Mod\nShen21",
  "Shen21 NVV" = "NVX\nShen21",
  "Wang21 BNT" = "BNT\nWang21",
  "Wang21 Mod" = "Mod\nWang21",
  "Wang21b CP" = "Wang21b\n",
  "Wang21b BNT" = "BNT\nWang21b",
  "Wang21b Mod" = "Mod\nWang21b",
  "Wibmer21 low titer" = "Titer < 400\nWibmer21",
  "Wibmer21 high titer" = "Titer > 400\nWibmer21",
  "Wu21 Mod" = "Mod\nWu21",
  "Xie21 BNT" = "BNT\nXie21",
  "Xie21b BNT" = "BNT\nXie21b"
)
yAxisStep = 5
longRefRxNames = names(shortRefRxNames)

dfForPlot = dfSuscResultsPlasma %>%
  filter(strain_name %in% filterStrains) %>%
  mutate(
    rx_name = ifelse(is.na(cumulative_group), rx_name, cumulative_group),
    vaccine_name = ifelse(is.na(vaccine_name), "NA", vaccine_name)
  )
dfForPlot = aggregate(
  cumulative_count ~ ref_name + rx_name + vaccine_name + strain_name + resistance_level + group,
  dfForPlot,
  FUN=sum,
  na.action = na.pass
)

resistance_levels = c(
  'resistance',
  'partial-resistance',
  'susceptible'
)

dfForPlot = dfForPlot %>%
  select(ref_name, rx_name, vaccine_name, strain_name, group) %>%
  unique %>%
  merge(
    data.frame(resistance_level = resistance_levels)
  ) %>%
  merge(
    dfForPlot,
    by = c('ref_name', 'rx_name', 'vaccine_name', 'strain_name', 'group', 'resistance_level'),
    all.x = TRUE
  ) %>%
  mutate(
    cumulative_count = ifelse(is.na(cumulative_count), 0, cumulative_count),
    resistance_level = factor(resistance_level, levels = resistance_levels),
    group = factor(
      group,
      levels = c("CP", "IP")
    ),
    ref_rx = paste(ref_name, rx_name, sep=" ")
  ) %>%
  mutate(
    ref_rx = factor(ref_rx, levels = unique(c(longRefRxNames, ref_rx)))
  )

plots = list()
i = 1

for (strain in filterStrains) {
  df = dfForPlot %>%
    filter(strain_name == strain)
  totalCount = aggregate(cbind(total_count = cumulative_count) ~ ref_rx + group, df, FUN = sum)
  maxCount = ceiling((max(totalCount$total_count)) / yAxisStep) * yAxisStep

  for (groupName in c("CP", "IP")) {
    dfGroup = df %>%
      filter(group == groupName)
    dfStrainLabel = data.frame(
      x = 0,
      y = maxCount,
      text = strainTitle[[strain]]
    )
    numItems = length(unique(dfGroup$ref_rx))
    plot = dfGroup %>%
      ggplot(aes(x = ref_rx, y = cumulative_count)) +
      geom_bar(
        aes(fill = resistance_level),
        size = 0.2,
        color = "#000000",
        stat = 'identity', position = 'stack', width = 0.07 * numItems) +
      scale_x_discrete(
        labels = Vectorize(function(x) ifelse(
          x %in% longRefRxNames,
          yes = shortRefRxNames[[x]],
          no = x
        ))
      ) +
      geom_text(
        aes(x = ref_rx, y = total_count, label = total_count),
        data = totalCount %>% filter(group == groupName),
        size = 3,
        vjust = -0.5
      ) +
      scale_y_continuous(
        expand = c(0, 0, 0.15, 0),
        limits = c(0, maxCount),
        breaks = seq(0, maxCount, yAxisStep)
      ) +
      # labs(title = strain) +
      scale_fill_manual(values = c("#146aa8", "#7fcbee", "#ffffff")) +
      theme(
        plot.title = element_text(hjust = 0.5),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        strip.background = element_blank(),
        strip.placement = "outside",
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "none",
        panel.border = element_rect(fill = NA, color = 'black')
      )
    if (i < 3) {
      plot = plot + ggtitle(groupTitle[[groupName]])
    }
    if (i %% 2 == 1) {
      plot = plot + geom_text(
        aes(x, y, label = text), data = dfStrainLabel,
        nudge_x = 0.5,
        hjust = 0,
        vjust = -0.5
      )
    }
    else {
      plot = plot + theme(
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank()
      )
    }
    plots[[i]] = plot
    i = i + 1
  }
}
grid.arrange(grobs = plots, nrow = 4)
```

## Monoclonal antibodies

```{r mab-fold-fig, fig.height = 10, fig.width = 12, fig.retina = 4}
filterMAbs = c(
  "Bamlanivimab", "Casirivimab", "Imdevimab", "Etesevimab",
  "Vir-7831", "C121", "C135", "C144",
  "COV2-2479", "COV2-2832",
  "CC12.1", "BD23", "C119", "P2B-2F6"
)
mAbLevels = c(
  "Bamlanivimab", "Casirivimab", "Imdevimab", "Casirivimab+\nImdevimab", "Etesevimab",
  "Vir-7831", "C121", "C135", "C144",
  "COV2-2479", "COV2-2832",
  "CC12.1", "BD23", "C119", "P2B-2F6"
)
mAbLabels = c(
  "Bamlanivimab" = "BAM",
  "Casirivimab" = "CAS",
  "Imdevimab" = "IMD",
  "Casirivimab+\nImdevimab" = "CAS-IMD",
  "Etesevimab" = "ETE",
  "Vir-7831" = "Vir-7831\n(S309)",
  "C121" = "C121\n(RBM 1)",
  "C135" = "C135\n(RBD-core 1)",
  "C144" = "C144\n(RBM 3)",
  "CC12.1" = "CC12.1\n(RBM 1)",
  "BD23" = "BD23\n(RBM 3)",
  "C119" = "C119\n(RBM 2)",
  "P2B-2F6" = "P2B-2F6\n(RBM 2)"
)
mAbHasLabels = names(mAbLabels)

dfForPlot = dfSuscResultsMAb %>%
  filter(
    Vectorize(function(x) length(setdiff(x, filterMAbs)) == 0)(ab_name) &
    strain_name %in% filterStrains
  )  %>%
  mutate(
    fold_cmp = ifelse(fold > 100, ">", fold_cmp),
    fold = ifelse(fold > 100, 100, fold),
    strain_name = factor(strain_name, levels = filterStrains),
    ab_name = factor(
      Vectorize(function(x) paste(x, collapse = "+\n"))(ab_name),
      levels = mAbLevels
    )
  ) %>%
  select(ref_name, ab_name, strain_name, fold_cmp, fold)

plots = list()
i = 1

dfStrainLabel = data.frame(
  x = 0,
  y = 190,
  strain_name = names(strainTitle),
  text = strainTitle
)

dfHLines = data.frame(
  y = c(1, 3, 10, 30, 100)
)

dfForPlot %>%
  ggplot(aes(x = ab_name, y = fold)) +
  geom_hline(aes(yintercept = y), data = dfHLines, linetype = "dashed", color = "#e0e0e0") +
  geom_bar(
    aes(fill = ref_name),
    size = 0.2,
    color = "#000000",
    stat = 'identity', position = position_dodge2(preserve = 'single'), width = 0.6) +
  labs(fill = "References") +
  geom_text(
    aes(
      y = Vectorize(function(x) min(x, 190))(fold),
      label = ifelse(
        fold_cmp == ">",
        sprintf(">%s", formatC(fold, digits = 1, format = 'fg')),
        ""
      )
    ),
    position = position_dodge2(preserve = 'single', width = 0.6),
    size = 2.5,
    vjust = -0.5
  ) +
  geom_text(
    aes(x, y, label = text),
    data = dfStrainLabel,
    nudge_x = 0.5,
    hjust = 0,
    vjust = 0
  ) +
  scale_x_discrete(labels = Vectorize(function(x) ifelse(
    x %in% mAbHasLabels,
    yes = mAbLabels[[x]],
    no = x
  ))) +
  scale_y_continuous(
    trans=scales::pseudo_log_trans(base = 10),
    expand = c(0, 0, 0.1, 0),
    breaks = c(0, 1, 3, 10, 30, 100)
  ) +
  coord_cartesian(ylim = c(0, 200)) +
  facet_wrap(~ strain_name, scales = "free_x", nrow = 4) +
  theme(
    plot.title = element_text(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    strip.background = element_blank(),
    strip.text = element_blank(),
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(fill = NA, color = 'black')
  )
```
